package gogen

import (
	"strings"
	"text/template"
)

var ros2MsgToGolangTypeTemplate = template.Must(template.New("ros2MsgToGolangTypeTemplate").Funcs(template.FuncMap{
	"lc":           strings.ToLower,
	"camelToSnake": CamelToSnake,
}).Parse(`
{{ $Md := . }}

package {{ $Md.RosPackage }}
import (
	{{- range $k, $v := $Md.GoImports }}
	"{{ $k }}"
	{{- end }}
)
/*
#cgo LDFLAGS: -L/opt/ros/foxy/lib -Wl,-rpath=/opt/ros/foxy/lib -lrcl -lrosidl_runtime_c -lrosidl_typesupport_c -lrcutils -lrmw_implementation
#cgo LDFLAGS: -l{{$Md.RosPackage}}__rosidl_typesupport_c -l{{$Md.RosPackage}}__rosidl_generator_c
{{range $k, $v := $Md.CImports -}}
#cgo LDFLAGS: -l{{$k}}__rosidl_typesupport_c -l{{$k}}__rosidl_generator_c
{{- end}}
#cgo CFLAGS: -I/opt/ros/foxy/include

#include <rosidl_runtime_c/message_type_support_struct.h>
#include <{{$Md.RosPackage}}/msg/{{$Md.RosMsgName | camelToSnake}}.h>
*/
import "C"
import "unsafe"
import "github.com/tiiuae/rclgo/pkg/ros2"

{{- if $Md.Constants }}
const (
{{- range $Md.Constants }}
	{{ $Md.RosMsgName }}_{{ .RosName }} {{ .GoType }} = {{ .Value }}{{if .Comment -}} // {{.Comment}}{{- end}}
{{- end }}
)
{{- end }}

type {{.RosMsgName}} struct {
	{{- range $k, $v := .Fields }}
	{{$v.GoName }} {{$v.TypeArray}}` +
	`{{if $v.PkgIsLocal -}}*{{$v.GoType}}` +
	`{{- else if $v.PkgName -}}{{$v.PkgName}}.{{$v.GoType}}` +
	`{{- else -}}{{$v.GoType}}` +
	`{{- end}}` +
	"{{\"\"}} `yaml:\"{{$v.RosName}}\"`" + `{{if .Comment -}} // {{.Comment}}{{- end}}
	{{- end }}
}

func (t *{{.RosMsgName}}) TypeSupport() unsafe.Pointer {
	return unsafe.Pointer(C.rosidl_typesupport_c__get_message_type_support_handle__{{.RosPackage}}__msg__{{.RosMsgName}}())
}
func (t *{{.RosMsgName}}) PrepareMemory() unsafe.Pointer { //returns *C.{{.RosPackage}}__msg__{{.RosMsgName}}
	return (unsafe.Pointer)(C.{{.RosPackage}}__msg__{{.RosMsgName}}__create())
}
func (t *{{.RosMsgName}}) ReleaseMemory(pointer_to_free unsafe.Pointer) {
	C.{{.RosPackage}}__msg__{{.RosMsgName}}__destroy((*C.{{.RosPackage}}__msg__{{.RosMsgName}})(pointer_to_free))
}
func (t *{{.RosMsgName}}) AsCStruct() unsafe.Pointer {
	//TODO serdes for nested structs, just call the AsGo/CStruct
	mem := (*C.{{.RosPackage}}__msg__{{.RosMsgName}})(t.PrepareMemory())
	{{- range .Fields }}
	mem.{{.CName}} = ` +
	`{{if .PkgName -}}*(*C.{{if .PkgIsLocal -}}{{$Md.RosPackage}}{{- else -}}{{.PkgName}}{{- end}}__msg__{{.CType}})(t.{{.GoName}}.AsCStruct())` +
	`{{- else -}}C.{{.CType}}(t.{{.GoName}})` +
	`{{- end}}
	{{- end }}
	return unsafe.Pointer(mem)
}
func (t *{{.RosMsgName}}) AsGoStruct(ros2_message_buffer unsafe.Pointer) {
	mem := (*C.{{.RosPackage}}__msg__{{.RosMsgName}})(ros2_message_buffer)
	{{- range .Fields }}
	{{if .PkgName -}}t.{{.GoName}}.AsGoStruct(unsafe.Pointer(&mem.{{.CName}}))` +
	`{{- else -}}t.{{.GoName}} = {{.GoType}}(mem.{{.CName}})
	{{- end}}` +
	`{{- end }}
}
func (t *{{.RosMsgName}}) Clone() ros2.ROS2Msg {
	clone := *t
	return &clone
}
`))

var ros2MsgsStaticImportsDispatcherTemplate = template.Must(template.New("ros2-msg-static-imports-dispatcher-template").Parse(`
// THIS FILE IS AUTOGENERATED BY 'rclgo generate'
/*
There is no practical and good way to dynamically load the required message definitions on demand,
se we have to statically include all of them, if we want to be able to do dynamic runtime casting to
unexpected ros2 message types.

The problem is that Golang doesnt allow dynamic imports. There is a plugin-system but that would still require
shared struct definitions between the core rclgo and the ros2-message-plugin-implementation,
which kinda make it not useful in this type of situation.

*/
package ros2_type_dispatcher

import (
	// Statically load ROS2 message definitions
	{{ range $k, $v := .Ros2PackagesMap -}}
	{{$k}} "github.com/tiiuae/rclgo/pkg/ros2/msgs/{{$k}}/msg"{{"\n\t"}}
	{{- end}}
)

/*
	Seed the type string to implementation dispatcher so the correct type can be dynamically chosen.
	Needs to be defined for all supported ROS2 message types.
*/
func init() {
	{{range .Mds -}}
	RegisterROS2MsgTypeNameAlias("{{.RosPackage}}/{{.RosMsgName}}", &{{.RosPackage}}.{{.RosMsgName}}{}){{"\n\t"}}
	{{- end}}
}

`))
